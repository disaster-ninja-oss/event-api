<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.kontur.eventapi.dao.mapper.KonturEventsMapper">

    <insert id="insert" useGeneratedKeys="false">
        INSERT INTO kontur_events (event_id, provider, observation_id)
        VALUES (#{eventId},
                (select provider from data_lake where observation_id = #{observationId}),
                #{observationId})
    </insert>

    <select id="getEventByExternalId" resultMap="konturEventDtoMap" >
        SELECT event_id, array_agg(observation_id)::uuid[] AS observation_ids
        FROM kontur_events
        WHERE observation_id IN (
            SELECT observation_id
            FROM normalized_observations
            WHERE external_event_id = #{externalId}
            )
        GROUP BY event_id
    </select>

    <select id="getEventById" resultMap="konturEventDtoMap" >
        SELECT event_id, array_agg(observation_id)::uuid[] AS observation_ids
        FROM kontur_events
        WHERE event_id = #{eventId}
        GROUP BY event_id
    </select>

    <select id="getEventWithClosestObservation" resultMap="konturEventDtoMap" >
        SELECT *
        FROM kontur_events
        WHERE observation_id in (
            SELECT observation_id
            FROM normalized_observations no
            WHERE
                no.source_updated_at between #{updatedAt} - interval '24 hours' and #{updatedAt} + interval '24 hours'
                AND ST_DWithin(ST_GeomFromGeoJSON(#{geometry})::geography, collected_geography, 1000)
                <foreach item="provider" collection="providers" separator="," open="AND provider in (" close=")">
                    #{provider}
                </foreach>
        ORDER BY ST_GeomFromGeoJSON(#{geometry})::geography <![CDATA[<->]]> collected_geography
        LIMIT 1
        )
    </select>

    <select id="getEventsForRolloutEpisodes" resultType="java.util.UUID">
        WITH feed_max_version as (SELECT fdl.event_id, MAX(fdl.version) as version FROM feed_data fdl group by fdl.event_id)
        SELECT ke.event_id
        FROM kontur_events ke, feeds f
        WHERE NOT EXISTS(SELECT 1
                        FROM (SELECT fdle.event_id, fdle.feed_id, unnest(observations) as observations
                                FROM feed_data fdle
                                INNER JOIN feed_max_version fdmv
                                    ON fdmv.event_id = fdle.event_id AND fdmv.version = fdle.version) fd
                        WHERE fd.event_id = ke.event_id
                        AND fd.observations = ke.observation_id
                        AND fd.feed_id = #{uuid}
        )
        AND ke.provider = ANY (f.providers)
        AND f.feed_id = #{uuid}
        GROUP BY ke.event_id
        LIMIT 100000;
    </select>

    <resultMap id="konturEventDtoMap" type="io.kontur.eventapi.entity.KonturEvent">
        <result property="eventId" column="event_id"/>
        <result property="observationIds" column="observation_ids" typeHandler="io.kontur.eventapi.typehandler.UUIDArrayTypeHandler"/>
    </resultMap>
</mapper>