<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.kontur.eventapi.dao.mapper.KonturEventsMapper">

    <insert id="insert" useGeneratedKeys="false">
        INSERT INTO kontur_events (event_id, version, observation_id)
        VALUES (#{eventId}, #{version}, #{observationId})
    </insert>

    <select id="getLatestEventByExternalId" resultMap="konturEventDtoMap" >
        SELECT *
        FROM kontur_events
        WHERE observation_id in (
            SELECT observation_id
            FROM normalized_observations
            WHERE external_id = #{externalId}
            )
        ORDER BY version DESC
        LIMIT 1
    </select>



    <resultMap id="konturEventDtoMap" type="io.kontur.eventapi.dto.KonturEventDto">
        <result property="eventId" column="event_id"/>
        <result property="version" column="version"/>
        <result property="observationId" column="observation_id"/>

    </resultMap>
</mapper>